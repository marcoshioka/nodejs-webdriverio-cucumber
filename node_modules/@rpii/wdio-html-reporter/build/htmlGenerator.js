"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

const Handlebars = require('handlebars');

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const moment = require('moment');

const Png = require("pngjs").PNG;

const Jpeg = require("jpeg-js");

const open = require('open');

const logger = require('@log4js-node/log4js-api');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

class HtmlGenerator {
  static htmlOutput(reportOptions, callback = () => {}) {
    try {
      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation started");
      }

      let templateFile = fs.readFileSync(reportOptions.templateFilename, 'utf8');
      Handlebars.registerHelper('imageAsBase64', function (screenshotFile, screenshotPath, hbopts) {
        // occurs when there is an error file
        if (!fs.existsSync(screenshotFile)) {
          screenshotFile = `${screenshotPath}/${screenshotFile}`;
        }

        let png = new Png.sync.read(fs.readFileSync(path.resolve(`${screenshotFile}`)));
        return `data:image/jpeg;base64,${Jpeg.encode(png, 50).data.toString('base64')}`;
      });
      Handlebars.registerHelper('isValidSuite', function (suite, hbopts) {
        if (suite.title.length > 0 && suite.type === 'suite' && suite.tests.length > 0) {
          return hbopts.fn(this);
        }
      });
      Handlebars.registerHelper('testStateColour', function (state, hbopts) {
        if (state === 'passed') {
          return 'test-pass';
        } else if (state === 'failed') {
          return 'test-fail';
        } else if (state === 'pending') {
          return 'test-pending';
        } else if (state === 'skipped') {
          return 'test-skipped';
        }
      });
      Handlebars.registerHelper('testStateIcon', function (state, hbopts) {
        if (state === 'passed') {
          return '<span class="success">&#10004;</span>';
        } else if (state === 'failed') {
          return '<span class="error">&#10006;</span>';
        } else if (state === 'pending') {
          return '<span class="pending">&#10004;</span>';
        } else if (state === 'skipped') {
          return '<span class="skipped">&#10034;</span>';
        }
      });
      Handlebars.registerHelper('suiteStateColour', function (tests, hbopts) {
        let numTests = Object.keys(tests).length;

        let fail = _.values(tests).find(test => {
          return test.state === 'failed';
        });

        if (fail != null) {
          return 'suite-fail';
        }

        let passes = _.values(tests).filter(test => {
          return test.state === 'passed';
        });

        if (passes.length === numTests && numTests > 0) {
          return 'suite-pass';
        } //skipped is the lowest priority check


        let skipped = _.values(tests).find(test => {
          return test.state === 'skipped';
        });

        if (skipped != null) {
          return 'suite-pending';
        }

        return 'suite-unknown';
      });
      Handlebars.registerHelper('humanizeDuration', function (duration, hbopts) {
        return moment.duration(duration, "milliseconds").format('hh:mm:ss.SS', {
          trim: false
        });
      });
      Handlebars.registerHelper('ifSuiteHasTests', function (testsHash, hbopts) {
        if (Object.keys(testsHash).length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsError', function (event, hbopts) {
        if (event.type.includes('Error')) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsScreenshot', function (event, hbopts) {
        if (event.type === 'screenshot') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsLogMessage', function (event, hbopts) {
        if (event.type === 'log') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('logClass', function (text, hbopts) {
        if (text.includes('Test Iteration')) {
          return "test-iteration";
        } else {
          return "log-output";
        }
      });
      Object.keys(reportOptions.templateFuncs).forEach(key => {
        Handlebars.registerHelper(key, reportOptions.templateFuncs[key]);
      });

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        let jsonFile = reportOptions.reportFile.replace('.html', '.json');
        fs.outputFileSync(jsonFile, JSON.stringify(reportOptions.data));
      }

      let template = Handlebars.compile(templateFile);
      let html = template(reportOptions.data);

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        fs.outputFileSync(reportOptions.reportFile, html);

        try {
          if (reportOptions.showInBrowser) {
            let childProcess = open(reportOptions.reportFile);
            childProcess.then(() => {
              console.log('browser launched');
            }, error => {
              console.error('showInBrowser error spawning :' + reportOptions.reportFile + " " + error.toString());
            });
          }
        } catch (ex) {
          console.error('Error opening browser:' + ex);
        }
      }

      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation completed");
      }

      callback(true);
    } catch (ex) {
      if (reportOptions.LOG) {
        reportOptions.LOG.error("Html Generation processing ended in error: " + ex);
      }

      callback(false);
    }
  }

}

var _default = HtmlGenerator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9odG1sR2VuZXJhdG9yLmpzIl0sIm5hbWVzIjpbIkhhbmRsZWJhcnMiLCJyZXF1aXJlIiwiZnMiLCJfIiwicGF0aCIsIm1vbWVudCIsIlBuZyIsIlBORyIsIkpwZWciLCJvcGVuIiwibG9nZ2VyIiwibW9tZW50RHVyYXRpb25Gb3JtYXRTZXR1cCIsIkh0bWxHZW5lcmF0b3IiLCJodG1sT3V0cHV0IiwicmVwb3J0T3B0aW9ucyIsImNhbGxiYWNrIiwiTE9HIiwiZGVidWciLCJ0ZW1wbGF0ZUZpbGUiLCJyZWFkRmlsZVN5bmMiLCJ0ZW1wbGF0ZUZpbGVuYW1lIiwicmVnaXN0ZXJIZWxwZXIiLCJzY3JlZW5zaG90RmlsZSIsInNjcmVlbnNob3RQYXRoIiwiaGJvcHRzIiwiZXhpc3RzU3luYyIsInBuZyIsInN5bmMiLCJyZWFkIiwicmVzb2x2ZSIsImVuY29kZSIsImRhdGEiLCJ0b1N0cmluZyIsInN1aXRlIiwidGl0bGUiLCJsZW5ndGgiLCJ0eXBlIiwidGVzdHMiLCJmbiIsInN0YXRlIiwibnVtVGVzdHMiLCJPYmplY3QiLCJrZXlzIiwiZmFpbCIsInZhbHVlcyIsImZpbmQiLCJ0ZXN0IiwicGFzc2VzIiwiZmlsdGVyIiwic2tpcHBlZCIsImR1cmF0aW9uIiwiZm9ybWF0IiwidHJpbSIsInRlc3RzSGFzaCIsImludmVyc2UiLCJldmVudCIsImluY2x1ZGVzIiwidGV4dCIsInRlbXBsYXRlRnVuY3MiLCJmb3JFYWNoIiwia2V5IiwicGF0aEV4aXN0c1N5bmMiLCJvdXRwdXREaXIiLCJqc29uRmlsZSIsInJlcG9ydEZpbGUiLCJyZXBsYWNlIiwib3V0cHV0RmlsZVN5bmMiLCJKU09OIiwic3RyaW5naWZ5IiwidGVtcGxhdGUiLCJjb21waWxlIiwiaHRtbCIsInNob3dJbkJyb3dzZXIiLCJjaGlsZFByb2Nlc3MiLCJ0aGVuIiwiY29uc29sZSIsImxvZyIsImVycm9yIiwiZXgiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUNBLE1BQU1BLFVBQVUsR0FB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QkMsRUFBekM7QUFDSDtBQUNKOztBQUNELFVBQUloRSxhQUFhLENBQUNFLEdBQWxCLEVBQXVCO0FBQ25CRixRQUFBQSxhQUFhLENBQUNFLEdBQWQsQ0FBa0JDLEtBQWxCLENBQXdCLDJCQUF4QjtBQUNIOztBQUNERixNQUFBQSxRQUFRLENBQUMsSUFBRCxDQUFSO0FBQ0gsS0F0SkQsQ0FzSkUsT0FBTStELEVBQU4sRUFBVTtBQUNSLFVBQUloRSxhQUFhLENBQUNFLEdBQWxCLEVBQXVCO0FBQ25CRixRQUFBQSxhQUFhLENBQUNFLEdBQWQsQ0FBa0I2RCxLQUFsQixDQUF3QixnREFBZ0RDLEVBQXhFO0FBQ0g7O0FBQ0QvRCxNQUFBQSxRQUFRLENBQUMsS0FBRCxDQUFSO0FBQ0g7QUFDSjs7QUEvSmdCOztlQWtLTkgsYSIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5jb25zdCBIYW5kbGViYXJzID0gcmVxdWlyZSgnaGFuZGxlYmFycycpO1xyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XHJcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XHJcbmNvbnN0IFBuZyA9IHJlcXVpcmUoXCJwbmdqc1wiKS5QTkc7XHJcbmNvbnN0IEpwZWcgPSByZXF1aXJlKFwianBlZy1qc1wiKTtcclxuY29uc3Qgb3BlbiA9IHJlcXVpcmUoJ29wZW4nKTtcclxuY29uc3QgbG9nZ2VyID0gcmVxdWlyZSgnQGxvZzRqcy1ub2RlL2xvZzRqcy1hcGknKTtcclxuXHJcbmNvbnN0IG1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAgPSByZXF1aXJlKFwibW9tZW50LWR1cmF0aW9uLWZvcm1hdFwiKTtcclxubW9tZW50RHVyYXRpb25Gb3JtYXRTZXR1cChtb21lbnQpO1xyXG5cclxuY2xhc3MgSHRtbEdlbmVyYXRvciAge1xyXG5cclxuICAgIHN0YXRpYyBodG1sT3V0cHV0KHJlcG9ydE9wdGlvbnMsIGNhbGxiYWNrID0gKCkgPT57fSkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgIGlmIChyZXBvcnRPcHRpb25zLkxPRykge1xyXG4gICAgICAgICAgICAgICAgcmVwb3J0T3B0aW9ucy5MT0cuZGVidWcoXCJIdG1sIEdlbmVyYXRpb24gc3RhcnRlZFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBsZXQgdGVtcGxhdGVGaWxlID0gZnMucmVhZEZpbGVTeW5jKHJlcG9ydE9wdGlvbnMudGVtcGxhdGVGaWxlbmFtZSwgJ3V0ZjgnKTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2ltYWdlQXNCYXNlNjQnLCBmdW5jdGlvbiAoc2NyZWVuc2hvdEZpbGUsIHNjcmVlbnNob3RQYXRoLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIC8vIG9jY3VycyB3aGVuIHRoZXJlIGlzIGFuIGVycm9yIGZpbGVcclxuICAgICAgICAgICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhzY3JlZW5zaG90RmlsZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICBzY3JlZW5zaG90RmlsZSA9IGAke3NjcmVlbnNob3RQYXRofS8ke3NjcmVlbnNob3RGaWxlfWBcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGxldCBwbmcgPSBuZXcgUG5nLnN5bmMucmVhZChmcy5yZWFkRmlsZVN5bmMocGF0aC5yZXNvbHZlKGAke3NjcmVlbnNob3RGaWxlfWApKSk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYGRhdGE6aW1hZ2UvanBlZztiYXNlNjQsJHtKcGVnLmVuY29kZShwbmcsIDUwKS5kYXRhLnRvU3RyaW5nKCdiYXNlNjQnKX1gXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaXNWYWxpZFN1aXRlJywgZnVuY3Rpb24gKHN1aXRlLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdWl0ZS50aXRsZS5sZW5ndGggPiAwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgc3VpdGUudHlwZSA9PT0gJ3N1aXRlJyAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHN1aXRlLnRlc3RzLmxlbmd0aCA+IDAgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZXN0U3RhdGVDb2xvdXInLCBmdW5jdGlvbiAoc3RhdGUsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlID09PSAncGFzc2VkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAndGVzdC1wYXNzJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdmYWlsZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd0ZXN0LWZhaWwnO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3BlbmRpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd0ZXN0LXBlbmRpbmcnO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3NraXBwZWQnKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3Rlc3Qtc2tpcHBlZCc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZXN0U3RhdGVJY29uJywgZnVuY3Rpb24gKHN0YXRlLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gJ3Bhc3NlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwic3VjY2Vzc1wiPiYjMTAwMDQ7PC9zcGFuPicgO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ2ZhaWxlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwiZXJyb3JcIj4mIzEwMDA2Ozwvc3Bhbj4nIDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdwZW5kaW5nJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCJwZW5kaW5nXCI+JiMxMDAwNDs8L3NwYW4+JyA7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAnc2tpcHBlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwic2tpcHBlZFwiPiYjMTAwMzQ7PC9zcGFuPicgO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3N1aXRlU3RhdGVDb2xvdXInLCBmdW5jdGlvbiAodGVzdHMsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgbGV0IG51bVRlc3RzID0gT2JqZWN0LmtleXModGVzdHMpLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgZmFpbCA9IF8udmFsdWVzKHRlc3RzKS5maW5kKCh0ZXN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT09ICdmYWlsZWQnO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGlmIChmYWlsICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLWZhaWwnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGxldCBwYXNzZXMgPSBfLnZhbHVlcyh0ZXN0cykuZmlsdGVyKCh0ZXN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT09ICdwYXNzZWQnO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGlmIChwYXNzZXMubGVuZ3RoID09PSBudW1UZXN0cyAmJiBudW1UZXN0cyA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLXBhc3MnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vc2tpcHBlZCBpcyB0aGUgbG93ZXN0IHByaW9yaXR5IGNoZWNrXHJcbiAgICAgICAgICAgICAgICBsZXQgc2tpcHBlZCA9IF8udmFsdWVzKHRlc3RzKS5maW5kKCh0ZXN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT09ICdza2lwcGVkJztcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBpZiAoc2tpcHBlZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdzdWl0ZS1wZW5kaW5nJztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLXVua25vd24nXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaHVtYW5pemVEdXJhdGlvbicsIGZ1bmN0aW9uIChkdXJhdGlvbiwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9tZW50LmR1cmF0aW9uKGR1cmF0aW9uLCBcIm1pbGxpc2Vjb25kc1wiKS5mb3JtYXQoJ2hoOm1tOnNzLlNTJywge3RyaW06IGZhbHNlfSlcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZlN1aXRlSGFzVGVzdHMnLCBmdW5jdGlvbiAodGVzdHNIYXNoLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyh0ZXN0c0hhc2gpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lmRXZlbnRJc0Vycm9yJywgZnVuY3Rpb24gKGV2ZW50LCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC50eXBlLmluY2x1ZGVzKCdFcnJvcicpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZkV2ZW50SXNTY3JlZW5zaG90JywgZnVuY3Rpb24gKGV2ZW50LCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAnc2NyZWVuc2hvdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5pbnZlcnNlKHRoaXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lmRXZlbnRJc0xvZ01lc3NhZ2UnLCBmdW5jdGlvbiAoZXZlbnQsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICdsb2cnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2dDbGFzcycsIGZ1bmN0aW9uICh0ZXh0ICwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGV4dC5pbmNsdWRlcygnVGVzdCBJdGVyYXRpb24nKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcInRlc3QtaXRlcmF0aW9uXCI7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcImxvZy1vdXRwdXRcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhyZXBvcnRPcHRpb25zLnRlbXBsYXRlRnVuY3MpLmZvckVhY2goKGtleSk9PntcclxuICAgICAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoa2V5LCByZXBvcnRPcHRpb25zLnRlbXBsYXRlRnVuY3Nba2V5XSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKGZzLnBhdGhFeGlzdHNTeW5jKHJlcG9ydE9wdGlvbnMub3V0cHV0RGlyKSkge1xyXG4gICAgICAgICAgICAgICBsZXQganNvbkZpbGUgPSByZXBvcnRPcHRpb25zLnJlcG9ydEZpbGUucmVwbGFjZSgnLmh0bWwnICwgJy5qc29uJykgO1xyXG4gICAgICAgICAgICAgICAgICAgIGZzLm91dHB1dEZpbGVTeW5jKGpzb25GaWxlLCBKU09OLnN0cmluZ2lmeShyZXBvcnRPcHRpb25zLmRhdGEpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IHRlbXBsYXRlID0gSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlRmlsZSk7XHJcbiAgICAgICAgICAgIGxldCBodG1sID0gdGVtcGxhdGUocmVwb3J0T3B0aW9ucy5kYXRhKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChmcy5wYXRoRXhpc3RzU3luYyhyZXBvcnRPcHRpb25zLm91dHB1dERpcikpIHtcclxuICAgICAgICAgICAgICAgIGZzLm91dHB1dEZpbGVTeW5jKHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZSwgaHRtbCk7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXBvcnRPcHRpb25zLnNob3dJbkJyb3dzZXIpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjaGlsZFByb2Nlc3MgPSBvcGVuKHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkUHJvY2Vzcy50aGVuKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdicm93c2VyIGxhdW5jaGVkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignc2hvd0luQnJvd3NlciBlcnJvciBzcGF3bmluZyA6JyArIHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZSArIFwiIFwiICsgZXJyb3IudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igb3BlbmluZyBicm93c2VyOicgKyBleCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHJlcG9ydE9wdGlvbnMuTE9HKSB7XHJcbiAgICAgICAgICAgICAgICByZXBvcnRPcHRpb25zLkxPRy5kZWJ1ZyhcIkh0bWwgR2VuZXJhdGlvbiBjb21wbGV0ZWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSk7XHJcbiAgICAgICAgfSBjYXRjaChleCkge1xyXG4gICAgICAgICAgICBpZiAocmVwb3J0T3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgICAgIHJlcG9ydE9wdGlvbnMuTE9HLmVycm9yKFwiSHRtbCBHZW5lcmF0aW9uIHByb2Nlc3NpbmcgZW5kZWQgaW4gZXJyb3I6IFwiICsgZXgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IEh0bWxHZW5lcmF0b3I7XHJcbiJdfQ==