"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _reporter = _interopRequireDefault(require("@wdio/reporter"));

var _htmlGenerator = _interopRequireDefault(require("./htmlGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const moment = require('moment');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

const logger = require('log4js');

const log4js = require('@log4js-node/log4js-api');

class HtmlReporter extends _reporter.default {
  constructor(opts) {
    opts = Object.assign({}, {
      stdout: true,
      outputDir: 'reports/html-reports/',
      filename: 'report.html',
      templateFilename: path.resolve(__dirname, '../src/wdio-html-reporter-template.hbs'),
      templateFuncs: {},
      reportTitle: 'Test Report Title',
      showInBrowser: false,
      useOnAfterCommandForScreenshot: true,
      LOG: null
    }, opts);
    super(opts);
    this.options = opts;

    if (!this.options.LOG) {
      this.options.LOG = logger.getLogger("default");
    }

    const dir = this.options.outputDir + 'screenshots';
    fs.ensureDirSync(dir);
    this.suiteUids = [];
    this.suites = [];
    this.indents = 0;
    this.suiteIndents = {};
    this.metrics = {
      passed: 0,
      skipped: 0,
      failed: 0,
      start: 0,
      end: 0,
      duration: 0
    };
    this.openInProgress = false;
    this.defaultTestIndent = '   ';
    process.on('test:log', this.saveMessage.bind(this));
    process.on('test:screenshot', this.saveScreenshot.bind(this));
  }

  get isSynchronised() {
    return !this.openInProgress;
  }

  onRunnerStart(runner) {
    this.log("onRunnerStart: ", JSON.stringify(runner)); //todo look at fix, not async safe. but one cid per report file

    this.cid = runner.cid;
    this.metrics.passed = 0;
    this.metrics.skipped = 0;
    this.metrics.failed = 0;
  }

  onSuiteStart(suite) {
    this.suiteUids.push(suite.uid);
    this.suiteIndents[suite.uid] = ++this.indents;
    this.suiteUid = suite.uid;
    let thisSuite = Object.assign({}, suite);
    thisSuite.type = 'suite';
    this.suites.push(thisSuite);
    this.log("onSuiteStart: ", JSON.stringify(thisSuite));
  }

  onTestStart(theTest) {
    this.log("onTestStart: ", JSON.stringify(theTest));
    this.testUid = theTest.uid;
    let test = this.getTest(theTest.uid);
    test.events = [];
    test.errorIndex = 0;
  }

  onTestPass(test) {
    this.log("onTestPass: ", JSON.stringify(test));
    this.metrics.passed++;
  }

  onTestSkip(test) {
    this.log("onTestSkip: ", JSON.stringify(test));
    this.metrics.skipped++;
  }

  onTestFail(test) {
    this.log("onTestFail: ", JSON.stringify(test));
    this.moveErrorsToEvents(test);
    this.metrics.failed++;
  }

  onHookEnd(hook) {
    if (hook.error) {
      this.metrics.failed++;
    }
  }

  onTestEnd(theTest) {
    this.log("onTestEnd: ", JSON.stringify(theTest));
    let test = this.getTest(theTest.uid);
    this.moveErrorsToEvents(test);
  }

  onSuiteEnd(suite) {
    this.log("onSuiteEnd: ", JSON.stringify(suite));
    this.indents--;
  }

  isScreenshotCommand(command) {
    const isScreenshotEndpoint = /\/session\/[^/]*\/screenshot/;
    return isScreenshotEndpoint.test(command.endpoint);
  } //this is a hack to get around lack of onScreenshot event


  onAfterCommand(command) {
    if (this.options.useOnAfterCommandForScreenshot) {
      if (this.isScreenshotCommand(command) && command.result.value) {
        const timestamp = moment().format('YYYYMMDD-HHmmss.SSS');
        const filepath = path.join(this.options.outputDir, '/screenshots/', this.cid, timestamp, this.options.filename + '.png');
        this.log("onAfterCommand: taking screenshot " + filepath);
        fs.outputFileSync(filepath, Buffer.from(command.result.value, 'base64'));
        let test = this.getTest(this.testUid);
        test.events.push({
          type: 'screenshot',
          value: filepath
        });
      }
    }
  }

  log(message, object) {
    if (this.options.LOG || this.options.debug) {
      this.options.LOG.debug(message + object);
    }
  }

  getSuite(uid) {
    for (let i = 0; i < this.suites.length; i++) {
      if (uid === this.suites[i].uid) {
        return this.suites[i];
      }
    }

    return null;
  }

  getTest(uid) {
    let suite = this.getSuite(this.suiteUid);

    for (let i = 0; i < suite.tests.length; i++) {
      if (uid === suite.tests[i].uid) {
        return suite.tests[i];
      }
    }

    return null;
  } //this is a hack.  we have to move all the things in test.errors before they get blown away


  moveErrorsToEvents(test) {
    if (test.errors) {
      for (let i = test.errorIndex; i < test.errors.length; i++) {
        test.events.push({
          type: 'Error',
          ...test.errors[i]
        });
      }

      test.errorIndex = test.errors.length;
    }
  }

  saveScreenshot(filepath) {
    let test = this.getTest(this.testUid);
    this.moveErrorsToEvents(test);
    test.events.push({
      type: 'screenshot',
      value: filepath
    });
  }

  saveMessage(message) {
    const test = this.getTest(this.testUid);
    this.moveErrorsToEvents(test);
    test.events.push({
      type: 'log',
      value: message
    });
  }

  getOrderedSuites() {
    if (this.orderedSuites) {
      return this.orderedSuites;
    }

    this.orderedSuites = [];

    for (const uid of this.suiteUids) {
      for (const suite of this.suites) {
        if (suite.uid !== uid) {
          continue;
        }

        this.orderedSuites.push(suite);
      }
    }

    return this.orderedSuites;
  } // convert to a style class


  indent(uid) {
    const indents = this.suiteIndents[uid];
    return indents === 0 ? '' : Array(indents).join('    ');
  }

  onRunnerEnd(runner) {
    let self = this;
    this.log("onRunnerEnd: ", JSON.stringify(runner));
    self.openInProgress = true;
    self.metrics.start = runner.start;
    self.metrics.end = runner.end;
    self.metrics.duration = runner._duration;
    const reportOptions = {
      data: {
        info: runner,
        metrics: self.metrics,
        suites: self.getOrderedSuites(),
        title: self.options.reportTitle
      },
      showInBrowser: self.options.showInBrowser,
      outputDir: self.options.outputDir,
      reportFile: path.join(process.cwd(), self.options.outputDir, self.suiteUid, self.cid, self.options.filename),
      templateFilename: self.options.templateFilename,
      templateFuncs: self.options.templateFuncs
    };

    _htmlGenerator.default.htmlOutput(reportOptions, () => {
      self.openInProgress = false;
    });
  }

}

var _default = HtmlReporter;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRlci5qcyJdLCJuYW1lcyI6WyJmcyIsInJlcXVpcmUiLCJfIiwicGF0aCIsIm1vbWVudCIsIm1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAiLCJsb2dnZXIiLCJsb2c0anMiLCJIdG1sUmVwb3J0ZXIiLCJXRElPUmVwb3J0ZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJzdGRvdXQiLCJvdXRwdXREaXIiLCJmaWxlbmFtZSIsInRlbXBsYXRlRmlsZW5hbWUiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidGVtcGxhdGVGdW5jcyIsInJlcG9ydFRpdGxlIiwic2hvd0luQnJvd3NlciIsInVzZU9uQWZ0ZXJDb21tYW5kRm9yU2NyZWVuc2hvdCIsIkxPRyIsIm9wdGlvbnMiLCJnZXRMb2dnZXIiLCJkaXIiLCJlbnN1cmVEaXJTeW5jIiwic3VpdGVVaWRzIiwic3VpdGVzIiwiaW5kZW50cyIsInN1aXRlSW5kZW50cyIsIm1ldHJpY3MiLCJwYXNzZWQiLCJza2lwcGVkIiwiZmFpbGVkIiwic3RhcnQiLCJlbmQiLCJkdXJhdGlvbiIsIm9wZW5JblByb2dyZXNzIiwiZGVmYXVsdFRlc3RJbmRlbnQiLCJwcm9jZXNzIiwib24iLCJzYXZlTWVzc2FnZSIsImJpbmQiLCJzYXZlU2NyZWVuc2hvdCIsImlzU3luY2hyb25pc2VkIiwib25SdW5uZXJTdGFydCIsInJ1bm5lciIsImxvZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJjaWQiLCJvblN1aXRlU3RhcnQiLCJzdWl0ZSIsInB1c2giLCJ1aWQiLCJzdWl0ZVVpZCIsInRoaXNTdWl0ZSIsInR5cGUiLCJvblRlc3RTdGFydCIsInRoZVRlc3QiLCJ0ZXN0VWlkIiwidGVzdCIsImdldFRlc3QiLCJldmVudHMiLCJlcnJvckluZGV4Iiwib25UZXN0UGFzcyIsIm9uVGVzdFNraXAiLCJvblRlc3RGYWlsIiwibW92ZUVycm9yc1RvRXZlbnRzIiwib25Ib29rRW5kIiwiaG9vayIsImVycm9yIiwib25UZXN0RW5kIiwib25TdWl0ZUVuZCIsImlzU2NyZWVuc2hvdENvbW1hbmQiLCJjb21tYW5kIiwiaXNTY3JlZW5zaG90RW5kcG9pbnQiLCJlbmRwb2ludCIsIm9uQWZ0ZXJDb21tYW5kIiwicmVzdWx0IiwidmFsdWUiLCJ0aW1lc3RhbXAiLCJmb3JtYXQiLCJmaWxlcGF0aCIsImpvaW4iLCJvdXRwdXRGaWxlU3luYyIsIkJ1ZmZlciIsImZyb20iLCJtZXNzYWdlIiwib2JqZWN0IiwiZGVidWciLCJnZXRTdWl0ZSIsImkiLCJsZW5ndGgiLCJ0ZXN0cyIsImVycm9ycyIsImdldE9yZGVyZWRTdWl0ZXMiLCJvcmRlcmVkU3VpdGVzIiwiaW5kZW50IiwiQXJyYXkiLCJvblJ1bm5lckVuZCIsInNlbGYiLCJfZHVyYXRpb24iLCJyZXBvcnRPcHRpb25zIiwiZGF0YSIsImluZm8iLCJ0aXRsZSIsInJlcG9ydEZpbGUiLCJjd2QiLCJIdG1sR2VuZXJhdG9yIiwiaHRtbE91dHB1dCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUE7O0FBQ0E7Ozs7QUFFQSxNQUFNQSxFQUFFLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQWxCOztBQUNBLE1BQU1DLENBQUMsR0FBR0QsT0FBTyxDQUFDLFFBQUQsQ0FBakI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHRixPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNRyxNQUFNLEdBQUdILE9BQU8sQ0FBQyxRQUFELENBQXRCOztBQUNBLE1BQU1JLHlCQUF5QixHQUFHSixPQUFPLENBQUMsd0JBQUQsQ0FBekM7O0FBQ0FJLHlCQUF5QixDQUFDRCxNQUFELENBQXpCOztBQUNBLE1BQU1FLE1BQU0sR0FBR0wsT0FBTyxDQUFDLFFBQUQsQ0FBdEI7O0FBQWlDLE1BQU1NLE1BQU0sR0FBR04sT0FBTyxDQUFDLHlCQUFELENBQXRCOztBQUdqQyxNQUFNTyxZQUFOLFNBQTJCQyxpQkFBM0IsQ0FBd0M7QUFHcENDLEVBQUFBLFdBQVcsQ0FBQ0MsSUFBRCxFQUFPO0FBQ2RBLElB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QUFNO0FBQ3pDRixNQUFBQSxJQUFJLENBQUNoRSxjQUFMLEdBQXNCLEtBQXRCO0FBQ0gsS0FGRDtBQUdIOztBQWhPbUM7O2VBb096QmhDLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgV0RJT1JlcG9ydGVyIGZyb20gJ0B3ZGlvL3JlcG9ydGVyJ1xyXG5pbXBvcnQgSHRtbEdlbmVyYXRvciBmcm9tICcuL2h0bWxHZW5lcmF0b3InXHJcblxyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XHJcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcclxuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcclxuY29uc3QgbW9tZW50ID0gcmVxdWlyZSgnbW9tZW50Jyk7XHJcbmNvbnN0IG1vbWVudER1cmF0aW9uRm9ybWF0U2V0dXAgPSByZXF1aXJlKFwibW9tZW50LWR1cmF0aW9uLWZvcm1hdFwiKTtcclxubW9tZW50RHVyYXRpb25Gb3JtYXRTZXR1cChtb21lbnQpO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCdsb2c0anMnKTtjb25zdCBsb2c0anMgPSByZXF1aXJlKCdAbG9nNGpzLW5vZGUvbG9nNGpzLWFwaScpO1xyXG5cclxuXHJcbmNsYXNzIEh0bWxSZXBvcnRlciBleHRlbmRzIFdESU9SZXBvcnRlciB7XHJcblxyXG5cclxuICAgIGNvbnN0cnVjdG9yKG9wdHMpIHtcclxuICAgICAgICBvcHRzID0gT2JqZWN0LmFzc2lnbih7fSwge1xyXG4gICAgICAgICAgICBzdGRvdXQ6IHRydWUsXHJcbiAgICAgICAgICAgIG91dHB1dERpcjogJ3JlcG9ydHMvaHRtbC1yZXBvcnRzLycsXHJcbiAgICAgICAgICAgIGZpbGVuYW1lOiAncmVwb3J0Lmh0bWwnLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZpbGVuYW1lOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vc3JjL3dkaW8taHRtbC1yZXBvcnRlci10ZW1wbGF0ZS5oYnMnKSxcclxuICAgICAgICAgICAgdGVtcGxhdGVGdW5jczoge30sXHJcbiAgICAgICAgICAgIHJlcG9ydFRpdGxlOiAnVGVzdCBSZXBvcnQgVGl0bGUnLFxyXG4gICAgICAgICAgICBzaG93SW5Ccm93c2VyOiBmYWxzZSxcclxuICAgICAgICAgICAgdXNlT25BZnRlckNvbW1hbmRGb3JTY3JlZW5zaG90OiB0cnVlLFxyXG4gICAgICAgICAgICBMT0cgOiBudWxsXHJcbiAgICAgICAgfSwgb3B0cyk7XHJcbiAgICAgICAgc3VwZXIob3B0cyk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0cztcclxuICAgICAgICBpZiAoIXRoaXMub3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLkxPRyA9IGxvZ2dlci5nZXRMb2dnZXIoXCJkZWZhdWx0XCIpIDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgZGlyID0gdGhpcy5vcHRpb25zLm91dHB1dERpciArICdzY3JlZW5zaG90cycgO1xyXG5cclxuICAgICAgICBmcy5lbnN1cmVEaXJTeW5jKGRpcikgO1xyXG4gICAgICAgIHRoaXMuc3VpdGVVaWRzID0gW107XHJcbiAgICAgICAgdGhpcy5zdWl0ZXMgPSBbXTtcclxuICAgICAgICB0aGlzLmluZGVudHMgPSAwO1xyXG4gICAgICAgIHRoaXMuc3VpdGVJbmRlbnRzID0ge307XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzID0ge1xyXG4gICAgICAgICAgICBwYXNzZWQgOiAwLFxyXG4gICAgICAgICAgICBza2lwcGVkIDogMCxcclxuICAgICAgICAgICAgZmFpbGVkIDogMCxcclxuICAgICAgICAgICAgc3RhcnQ6IDAsXHJcbiAgICAgICAgICAgIGVuZDogMCAsXHJcbiAgICAgICAgICAgIGR1cmF0aW9uOjBcclxuICAgICAgICB9O1xyXG4gICAgICAgIHRoaXMub3BlbkluUHJvZ3Jlc3MgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmRlZmF1bHRUZXN0SW5kZW50ID0gJyAgICcgO1xyXG4gICAgICAgIHByb2Nlc3Mub24oJ3Rlc3Q6bG9nJywgdGhpcy5zYXZlTWVzc2FnZS5iaW5kKHRoaXMpKTtcclxuICAgICAgICBwcm9jZXNzLm9uKCd0ZXN0OnNjcmVlbnNob3QnLCB0aGlzLnNhdmVTY3JlZW5zaG90LmJpbmQodGhpcykpO1xyXG5cclxuICAgIH1cclxuXHJcbiAgICBnZXQgaXNTeW5jaHJvbmlzZWQgKCkge1xyXG4gICAgICAgIHJldHVybiAhdGhpcy5vcGVuSW5Qcm9ncmVzcyA7XHJcbiAgICB9XHJcblxyXG4gICAgb25SdW5uZXJTdGFydChydW5uZXIpIHtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uUnVubmVyU3RhcnQ6IFwiICwgSlNPTi5zdHJpbmdpZnkocnVubmVyKSk7XHJcbiAgICAgICAgLy90b2RvIGxvb2sgYXQgZml4LCBub3QgYXN5bmMgc2FmZS4gYnV0IG9uZSBjaWQgcGVyIHJlcG9ydCBmaWxlXHJcbiAgICAgICAgdGhpcy5jaWQgPSBydW5uZXIuY2lkO1xyXG4gICAgICAgIHRoaXMubWV0cmljcy5wYXNzZWQgPSAwO1xyXG4gICAgICAgIHRoaXMubWV0cmljcy5za2lwcGVkID0gMDtcclxuICAgICAgICB0aGlzLm1ldHJpY3MuZmFpbGVkID0gMDtcclxuICAgIH1cclxuXHJcbiAgICBvblN1aXRlU3RhcnQoc3VpdGUpIHtcclxuICAgICAgICB0aGlzLnN1aXRlVWlkcy5wdXNoKHN1aXRlLnVpZCk7XHJcbiAgICAgICAgdGhpcy5zdWl0ZUluZGVudHNbc3VpdGUudWlkXSA9ICsrdGhpcy5pbmRlbnRzO1xyXG4gICAgICAgIHRoaXMuc3VpdGVVaWQgPSBzdWl0ZS51aWQ7XHJcbiAgICAgICAgbGV0IHRoaXNTdWl0ZSA9IE9iamVjdC5hc3NpZ24oe30sIHN1aXRlKTtcclxuICAgICAgICB0aGlzU3VpdGUudHlwZSA9ICdzdWl0ZSc7XHJcbiAgICAgICAgdGhpcy5zdWl0ZXMucHVzaCh0aGlzU3VpdGUpO1xyXG4gICAgICAgIHRoaXMubG9nKFwib25TdWl0ZVN0YXJ0OiBcIiwgSlNPTi5zdHJpbmdpZnkodGhpc1N1aXRlKSk7XHJcbiAgICB9XHJcblxyXG4gICAgb25UZXN0U3RhcnQodGhlVGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0U3RhcnQ6IFwiICwgSlNPTi5zdHJpbmdpZnkodGhlVGVzdCkpO1xyXG4gICAgICAgIHRoaXMudGVzdFVpZCA9IHRoZVRlc3QudWlkIDtcclxuICAgICAgICBsZXQgdGVzdCA9IHRoaXMuZ2V0VGVzdCh0aGVUZXN0LnVpZCkgO1xyXG4gICAgICAgIHRlc3QuZXZlbnRzID0gW107XHJcbiAgICAgICAgdGVzdC5lcnJvckluZGV4ID0gMCA7XHJcbiAgICB9XHJcblxyXG4gICAgb25UZXN0UGFzcyh0ZXN0KSB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblRlc3RQYXNzOiBcIiAsIEpTT04uc3RyaW5naWZ5KHRlc3QpKTtcclxuICAgICAgICB0aGlzLm1ldHJpY3MucGFzc2VkKys7XHJcbiAgICB9XHJcblxyXG4gICAgb25UZXN0U2tpcCh0ZXN0KSB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblRlc3RTa2lwOiBcIiAsIEpTT04uc3RyaW5naWZ5KHRlc3QpKTtcclxuICAgICAgICB0aGlzLm1ldHJpY3Muc2tpcHBlZCsrO1xyXG4gICAgfVxyXG5cclxuICAgIG9uVGVzdEZhaWwodGVzdCkge1xyXG4gICAgICAgIHRoaXMubG9nKFwib25UZXN0RmFpbDogXCIgLCBKU09OLnN0cmluZ2lmeSh0ZXN0KSk7XHJcbiAgICAgICAgdGhpcy5tb3ZlRXJyb3JzVG9FdmVudHModGVzdCk7XHJcbiAgICAgICAgdGhpcy5tZXRyaWNzLmZhaWxlZCsrO1xyXG4gICAgfVxyXG5cclxuICAgIG9uSG9va0VuZChob29rKSB7XHJcbiAgICAgICAgaWYgKGhvb2suZXJyb3IpIHtcclxuICAgICAgICAgICAgdGhpcy5tZXRyaWNzLmZhaWxlZCsrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIG9uVGVzdEVuZCh0aGVUZXN0KSB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJvblRlc3RFbmQ6IFwiICwgSlNPTi5zdHJpbmdpZnkodGhlVGVzdCkpO1xyXG4gICAgICAgIGxldCB0ZXN0ID0gdGhpcy5nZXRUZXN0KHRoZVRlc3QudWlkKSA7XHJcbiAgICAgICAgdGhpcy5tb3ZlRXJyb3JzVG9FdmVudHModGVzdCkgO1xyXG4gICAgfVxyXG5cclxuICAgIG9uU3VpdGVFbmQoc3VpdGUpIHtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uU3VpdGVFbmQ6IFwiICwgSlNPTi5zdHJpbmdpZnkoc3VpdGUpKTtcclxuICAgICAgICB0aGlzLmluZGVudHMtLTtcclxuICAgIH1cclxuXHJcbiAgICBpc1NjcmVlbnNob3RDb21tYW5kKGNvbW1hbmQpIHtcclxuICAgICAgICBjb25zdCBpc1NjcmVlbnNob3RFbmRwb2ludCA9IC9cXC9zZXNzaW9uXFwvW14vXSpcXC9zY3JlZW5zaG90L1xyXG4gICAgICAgIHJldHVybiBpc1NjcmVlbnNob3RFbmRwb2ludC50ZXN0KGNvbW1hbmQuZW5kcG9pbnQpXHJcbiAgICB9XHJcblxyXG4gICAgLy90aGlzIGlzIGEgaGFjayB0byBnZXQgYXJvdW5kIGxhY2sgb2Ygb25TY3JlZW5zaG90IGV2ZW50XHJcbiAgICBvbkFmdGVyQ29tbWFuZChjb21tYW5kKSB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy51c2VPbkFmdGVyQ29tbWFuZEZvclNjcmVlbnNob3QpIHtcclxuICAgICAgICAgICAgaWYgKHRoaXMuaXNTY3JlZW5zaG90Q29tbWFuZChjb21tYW5kKSAmJiBjb21tYW5kLnJlc3VsdC52YWx1ZSkge1xyXG5cclxuICAgICAgICAgICAgICAgIGNvbnN0IHRpbWVzdGFtcCA9IG1vbWVudCgpLmZvcm1hdCgnWVlZWU1NREQtSEhtbXNzLlNTUycpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZXBhdGggPSBwYXRoLmpvaW4odGhpcy5vcHRpb25zLm91dHB1dERpciwgJy9zY3JlZW5zaG90cy8nLCB0aGlzLmNpZCwgdGltZXN0YW1wLCB0aGlzLm9wdGlvbnMuZmlsZW5hbWUgKyAnLnBuZycpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2coXCJvbkFmdGVyQ29tbWFuZDogdGFraW5nIHNjcmVlbnNob3QgXCIgKyBmaWxlcGF0aCk7XHJcbiAgICAgICAgICAgICAgICBmcy5vdXRwdXRGaWxlU3luYyhmaWxlcGF0aCwgQnVmZmVyLmZyb20oY29tbWFuZC5yZXN1bHQudmFsdWUsICdiYXNlNjQnKSk7XHJcblxyXG4gICAgICAgICAgICAgICAgbGV0IHRlc3QgPSB0aGlzLmdldFRlc3QodGhpcy50ZXN0VWlkKTtcclxuICAgICAgICAgICAgICAgIHRlc3QuZXZlbnRzLnB1c2goe3R5cGU6ICdzY3JlZW5zaG90JywgdmFsdWU6IGZpbGVwYXRofSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgbG9nKG1lc3NhZ2Usb2JqZWN0KSB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5MT0cgfHwgdGhpcy5vcHRpb25zLmRlYnVnICkge1xyXG4gICAgICAgICAgICB0aGlzLm9wdGlvbnMuTE9HLmRlYnVnKG1lc3NhZ2UgKyBvYmplY3QpIDtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBnZXRTdWl0ZSh1aWQpIHtcclxuICAgICAgICBmb3IgKGxldCBpID0gMCA7IGkgPCB0aGlzLnN1aXRlcy5sZW5ndGggOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKHVpZCA9PT0gdGhpcy5zdWl0ZXNbaV0udWlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5zdWl0ZXNbaV0gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIGdldFRlc3QodWlkKSB7XHJcbiAgICAgICAgbGV0IHN1aXRlID0gdGhpcy5nZXRTdWl0ZSh0aGlzLnN1aXRlVWlkKTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMCA7IGkgPCBzdWl0ZS50ZXN0cy5sZW5ndGggOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKHVpZCA9PT0gc3VpdGUudGVzdHNbaV0udWlkKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gc3VpdGUudGVzdHNbaV0gO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG5cclxuICAgIC8vdGhpcyBpcyBhIGhhY2suICB3ZSBoYXZlIHRvIG1vdmUgYWxsIHRoZSB0aGluZ3MgaW4gdGVzdC5lcnJvcnMgYmVmb3JlIHRoZXkgZ2V0IGJsb3duIGF3YXlcclxuXHJcbiAgICBtb3ZlRXJyb3JzVG9FdmVudHModGVzdCkge1xyXG4gICAgICAgIGlmICh0ZXN0LmVycm9ycykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gdGVzdC5lcnJvckluZGV4OyBpIDwgdGVzdC5lcnJvcnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIHRlc3QuZXZlbnRzLnB1c2goe3R5cGU6ICdFcnJvcicsIC4uLnRlc3QuZXJyb3JzW2ldfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGVzdC5lcnJvckluZGV4ID0gdGVzdC5lcnJvcnMubGVuZ3RoO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzYXZlU2NyZWVuc2hvdChmaWxlcGF0aCkge1xyXG4gICAgICAgIGxldCB0ZXN0ID0gdGhpcy5nZXRUZXN0KHRoaXMudGVzdFVpZCkgO1xyXG4gICAgICAgIHRoaXMubW92ZUVycm9yc1RvRXZlbnRzKHRlc3QpIDtcclxuICAgICAgICB0ZXN0LmV2ZW50cy5wdXNoKHt0eXBlOiAnc2NyZWVuc2hvdCcsIHZhbHVlOiBmaWxlcGF0aH0pIDtcclxuICAgIH1cclxuXHJcbiAgICBzYXZlTWVzc2FnZShtZXNzYWdlKSB7XHJcbiAgICAgICAgY29uc3QgdGVzdCA9IHRoaXMuZ2V0VGVzdCh0aGlzLnRlc3RVaWQpO1xyXG4gICAgICAgIHRoaXMubW92ZUVycm9yc1RvRXZlbnRzKHRlc3QpIDtcclxuICAgICAgICB0ZXN0LmV2ZW50cy5wdXNoKHt0eXBlOiAnbG9nJywgdmFsdWU6IG1lc3NhZ2V9KSA7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIGdldE9yZGVyZWRTdWl0ZXMoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMub3JkZXJlZFN1aXRlcykge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5vcmRlcmVkU3VpdGVzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5vcmRlcmVkU3VpdGVzID0gW107XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgdWlkIG9mIHRoaXMuc3VpdGVVaWRzKSB7XHJcbiAgICAgICAgICAgIGZvciAoY29uc3Qgc3VpdGUgb2YgdGhpcy5zdWl0ZXMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdWl0ZS51aWQgIT09IHVpZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMub3JkZXJlZFN1aXRlcy5wdXNoKHN1aXRlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3JkZXJlZFN1aXRlcztcclxuICAgIH1cclxuXHJcbi8vIGNvbnZlcnQgdG8gYSBzdHlsZSBjbGFzc1xyXG4gICAgaW5kZW50KHVpZCkge1xyXG4gICAgICAgIGNvbnN0IGluZGVudHMgPSB0aGlzLnN1aXRlSW5kZW50c1t1aWRdO1xyXG4gICAgICAgIHJldHVybiBpbmRlbnRzID09PSAwID8gJycgOiBBcnJheShpbmRlbnRzKS5qb2luKCcgICAgJyk7XHJcbiAgICB9XHJcblxyXG4gICAgb25SdW5uZXJFbmQocnVubmVyKSB7XHJcbiAgICAgICAgbGV0IHNlbGYgPSB0aGlzIDtcclxuICAgICAgICB0aGlzLmxvZyhcIm9uUnVubmVyRW5kOiBcIiAsIEpTT04uc3RyaW5naWZ5KHJ1bm5lcikpO1xyXG4gICAgICAgIHNlbGYub3BlbkluUHJvZ3Jlc3MgPSB0cnVlO1xyXG4gICAgICAgIHNlbGYubWV0cmljcy5zdGFydCA9IHJ1bm5lci5zdGFydCA7XHJcbiAgICAgICAgc2VsZi5tZXRyaWNzLmVuZCA9IHJ1bm5lci5lbmQgO1xyXG4gICAgICAgIHNlbGYubWV0cmljcy5kdXJhdGlvbiA9IHJ1bm5lci5fZHVyYXRpb247XHJcblxyXG4gICAgICAgIGNvbnN0IHJlcG9ydE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGRhdGEgOiB7XHJcbiAgICAgICAgICAgICAgICBpbmZvOiBydW5uZXIsXHJcbiAgICAgICAgICAgICAgICBtZXRyaWNzOiBzZWxmLm1ldHJpY3MsXHJcbiAgICAgICAgICAgICAgICBzdWl0ZXM6IHNlbGYuZ2V0T3JkZXJlZFN1aXRlcygpLFxyXG4gICAgICAgICAgICAgICAgdGl0bGU6IHNlbGYub3B0aW9ucy5yZXBvcnRUaXRsZVxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBzaG93SW5Ccm93c2VyIDogc2VsZi5vcHRpb25zLnNob3dJbkJyb3dzZXIsXHJcbiAgICAgICAgICAgIG91dHB1dERpciA6IHNlbGYub3B0aW9ucy5vdXRwdXREaXIsXHJcbiAgICAgICAgICAgIHJlcG9ydEZpbGUgOiBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgc2VsZi5vcHRpb25zLm91dHB1dERpciwgc2VsZi5zdWl0ZVVpZCAsIHNlbGYuY2lkLCBzZWxmLm9wdGlvbnMuZmlsZW5hbWUpLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZpbGVuYW1lOiBzZWxmLm9wdGlvbnMudGVtcGxhdGVGaWxlbmFtZSxcclxuICAgICAgICAgICAgdGVtcGxhdGVGdW5jczogc2VsZi5vcHRpb25zLnRlbXBsYXRlRnVuY3MsXHJcbiAgICAgICAgfTtcclxuICAgICAgICBIdG1sR2VuZXJhdG9yLmh0bWxPdXRwdXQocmVwb3J0T3B0aW9ucywoKSA9PiB7XHJcbiAgICAgICAgICAgIHNlbGYub3BlbkluUHJvZ3Jlc3MgPSBmYWxzZSAgO1xyXG4gICAgICAgIH0pXHJcbiAgICB9XHJcblxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBIdG1sUmVwb3J0ZXI7XHJcbiJdfQ==